<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Brainiac Admin Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
      :root {
        --brand: #ff6b00;
        --brand-dark: #e65100;
        --bg: #f8f9fa;
        --text: #333;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
      }
      body {
        background: var(--bg);
        color: var(--text);
        padding-top: 70px;
      }

      /* --- 1. RESPONSIVE NAVIGATION --- */
      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 70px;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        z-index: 1000;
      }

      .logo {
        font-size: 1.4rem;
        font-weight: 800;
        color: var(--brand);
        text-transform: uppercase;
      }

      .nav-links {
        display: flex;
        gap: 20px;
      }

      .nav-item {
        cursor: pointer;
        padding: 10px 15px;
        border-radius: 6px;
        font-weight: 600;
        color: #555;
        transition: 0.2s;
        user-select: none;
      }
      .nav-item:hover {
        background: #fff0e0;
        color: var(--brand);
      }
      .nav-item.active {
        background: var(--brand);
        color: white;
      }

      .btn-logout {
        padding: 8px 15px;
        border: 1px solid #ddd;
        background: transparent;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        margin-left: 10px;
      }

      /* Mobile Hamburger Icon (Hidden on Desktop) */
      .hamburger {
        display: none;
        font-size: 1.8rem;
        cursor: pointer;
        color: var(--brand);
      }

      /* --- MOBILE STYLES --- */
      @media (max-width: 768px) {
        .hamburger {
          display: block;
        }

        .nav-links {
          display: none; /* Hidden by default */
          position: absolute;
          top: 70px;
          left: 0;
          width: 100%;
          background: white;
          flex-direction: column;
          gap: 0;
          box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .nav-links.show {
          display: flex;
        } /* JavaScript adds this class */

        .nav-item {
          width: 100%;
          text-align: center;
          border-bottom: 1px solid #eee;
          padding: 15px;
          border-radius: 0;
        }
        .nav-item.active {
          border-radius: 0;
        }

        /* Stack controls on mobile */
        .controls {
          flex-direction: column;
        }
        .btn-main,
        select,
        input {
          width: 100%;
        }
      }

      /* --- SECTIONS --- */
      .page-section {
        display: none;
        max-width: 1000px;
        margin: 20px auto;
        padding: 0 15px;
      }
      .page-section.active {
        display: block;
        animation: fadeIn 0.3s ease-in-out;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      h2 {
        border-bottom: 3px solid var(--brand);
        display: inline-block;
        margin-bottom: 20px;
        padding-bottom: 5px;
      }

      /* --- CONTROLS & CARDS --- */
      .controls {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }
      select,
      input {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        flex-grow: 1;
      }
      .btn-main {
        background: var(--brand);
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        white-space: nowrap;
      }

      .data-list {
        display: grid;
        gap: 10px;
      }
      .card {
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 5px solid #ccc;
      }
      .card.active {
        border-left-color: #28a745;
      }
      .card.dropped {
        border-left-color: #dc3545;
        background: #fff5f5;
      }

      .info h4 {
        font-size: 1.1rem;
        margin-bottom: 3px;
      }
      .info p {
        color: #666;
        font-size: 0.9rem;
      }

      .actions button {
        margin-left: 5px;
        cursor: pointer;
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        color: white;
        font-size: 0.9rem;
      }
      .btn-drop {
        background: #dc3545;
      }
      .btn-restore {
        background: #28a745;
      }

      /* --- MODALS --- */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: white;
        padding: 25px;
        border-radius: 12px;
        width: 90%;
        max-width: 400px;
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
      }
      .modal-btns {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .btn-save {
        flex: 1;
        background: var(--brand);
        color: white;
        padding: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      .btn-cancel {
        flex: 1;
        background: #eee;
        color: #333;
        padding: 12px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <div class="logo">Brainiac Gym</div>

      <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>

      <div class="nav-links" id="nav-menu">
        <div
          id="nav-students"
          class="nav-item active"
          onclick="switchPage('page-students', 'nav-students')"
        >
          Students
        </div>
        <div
          id="nav-dropped"
          class="nav-item"
          onclick="switchPage('page-dropped', 'nav-dropped')"
        >
          Left/Dropped
        </div>
        <div
          id="nav-branches"
          class="nav-item"
          onclick="switchPage('page-branches', 'nav-branches')"
        >
          Branches
        </div>
        <div
          id="nav-teachers"
          class="nav-item"
          onclick="switchPage('page-teachers', 'nav-teachers')"
        >
          Teachers
        </div>
        <button class="btn-logout" onclick="logout()">Logout</button>
      </div>
    </nav>

    <section id="page-students" class="page-section active">
      <h2>Active Students</h2>
      <div class="controls">
        <select id="filter-branch" onchange="loadStudents()">
          <option value="all">All Branches</option>
        </select>
        <button class="btn-main" onclick="openModal('student-modal')">
          + New Student
        </button>
      </div>
      <div id="student-list" class="data-list">
        <p>Loading...</p>
      </div>
    </section>

    <section id="page-dropped" class="page-section">
      <h2 style="border-color: #dc3545">Left / Dropped Students</h2>
      <p style="margin-bottom: 15px; color: #666">
        Inactive students (Data preserved).
      </p>
      <div id="dropped-list" class="data-list"></div>
    </section>

    <section id="page-branches" class="page-section">
      <h2>Manage Branches</h2>
      <div class="controls">
        <input
          type="text"
          id="new-branch-name"
          placeholder="Branch Name (e.g. Rohini Sec-3)"
        />
        <button class="btn-main" onclick="createBranch()">Create</button>
      </div>
      <div id="branch-list" class="data-list"></div>
    </section>

    <section id="page-teachers" class="page-section">
      <h2>Teacher Assignments</h2>
      <div class="controls">
        <button
          class="btn-main"
          style="width: 100%"
          onclick="openModal('assign-modal')"
        >
          Assign Teacher to Branch
        </button>
      </div>
      <div id="teacher-list" class="data-list"></div>
    </section>

    <div id="student-modal" class="modal">
      <div class="modal-content">
        <h3>Add Student</h3>
        <form id="student-form">
          <div class="form-group">
            <label>Branch</label
            ><select id="modal-branch" required></select>
          </div>
          <div class="form-group">
            <label>Name</label><input type="text" id="m-name" required />
          </div>
          <div class="form-group">
            <label>Phone</label><input type="tel" id="m-phone" required />
          </div>
          <div class="form-group">
            <label>Fee (‚Çπ)</label><input type="number" id="m-fee" required />
          </div>
          <div class="form-group">
            <label>Billing Day</label
            ><input type="number" id="m-day" max="28" required />
          </div>
          <div class="modal-btns">
            <button
              type="button"
              class="btn-cancel"
              onclick="closeModal('student-modal')"
            >
              Cancel
            </button>
            <button type="submit" class="btn-save">Save</button>
          </div>
        </form>
      </div>
    </div>

    <div id="assign-modal" class="modal">
      <div class="modal-content">
        <h3>Assign Teacher</h3>
        <form id="assign-form">
          <div class="form-group">
            <label>Teacher</label
            ><select id="assign-teacher" required></select>
          </div>
          <div class="form-group">
            <label>Branch</label
            ><select id="assign-branch" required></select>
          </div>
          <div class="modal-btns">
            <button
              type="button"
              class="btn-cancel"
              onclick="closeModal('assign-modal')"
            >
              Cancel
            </button>
            <button type="submit" class="btn-save">Assign</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // --- CONFIGURATION ---
      const SUPABASE_URL = "https://moktlyeoljidtjbokqne.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1va3RseWVvbGppZHRqYm9rcW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMTIwODQsImV4cCI6MjA4NDU4ODA4NH0.ZnDXCZi58_srExZVLjMTsZVdrF-MyOpDDv27vVx_K5k";
      const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      // --- 1. NAVIGATION & UI LOGIC ---

      // Function to Toggle Mobile Menu
      function toggleMenu() {
        const nav = document.getElementById("nav-menu");
        nav.classList.toggle("show");
      }

      // Function to Switch Pages (Fixed Logic)
      function switchPage(pageId, navItemId) {
        // 1. Hide all pages
        document
          .querySelectorAll(".page-section")
          .forEach((el) => el.classList.remove("active"));

        // 2. Remove active style from all nav items
        document
          .querySelectorAll(".nav-item")
          .forEach((el) => el.classList.remove("active"));

        // 3. Show selected page & Highlight selected nav
        document.getElementById(pageId).classList.add("active");
        document.getElementById(navItemId).classList.add("active");

        // 4. Close mobile menu if open
        document.getElementById("nav-menu").classList.remove("show");

        // 5. Load Data for that page
        if (pageId === "page-students") loadStudents();
        if (pageId === "page-dropped") loadDropped();
        if (pageId === "page-branches") loadBranchesList();
        if (pageId === "page-teachers") loadTeachersList();
      }

      // --- 2. DATA LOADING ---

      async function init() {
        const {
          data: { session },
        } = await supabase.auth.getSession();
        if (!session) window.location.href = "index.html";

        loadBranchesDropdown();
        loadStudents(); // Default load
      }
      init();

      async function loadStudents() {
        const list = document.getElementById("student-list");
        const branchId = document.getElementById("filter-branch").value;
        list.innerHTML = '<p style="text-align:center">Loading...</p>';

        let query = supabase
          .from("students")
          .select("*")
          .eq("is_active", true)
          .order("name");
        if (branchId !== "all") query = query.eq("branch_id", branchId);

        const { data, error } = await query;
        if (error) return alert(error.message);

        list.innerHTML = "";
        if (data.length === 0)
          list.innerHTML =
            '<p style="text-align:center">No students found.</p>';

        data.forEach((s) => {
          list.innerHTML += `
                <div class="card active">
                    <div class="info">
                        <h4>${s.name}</h4>
                        <p>Fee: ‚Çπ${s.fee_amount} | Due: ${s.billing_day}th</p>
                    </div>
                    <div class="actions">
                        <button class="btn-drop" onclick="toggleStatus('${s.id}', false)">üóëÔ∏è Drop</button>
                    </div>
                </div>`;
        });
      }

      async function loadDropped() {
        const list = document.getElementById("dropped-list");
        list.innerHTML = '<p style="text-align:center">Loading...</p>';

        const { data } = await supabase
          .from("students")
          .select("*")
          .eq("is_active", false)
          .order("name");

        list.innerHTML = "";
        if (data.length === 0)
          list.innerHTML =
            '<p style="text-align:center">No dropped students.</p>';

        data.forEach((s) => {
          list.innerHTML += `
                <div class="card dropped">
                    <div class="info">
                        <h4>${s.name}</h4>
                        <p>Was paying: ‚Çπ${s.fee_amount}</p>
                    </div>
                    <div class="actions">
                        <button class="btn-restore" onclick="toggleStatus('${s.id}', true)">‚ôªÔ∏è Restore</button>
                    </div>
                </div>`;
        });
      }

      async function toggleStatus(id, newStatus) {
        if (!confirm("Are you sure you want to change this student's status?"))
          return;
        await supabase
          .from("students")
          .update({ is_active: newStatus })
          .eq("id", id);

        // Refresh current view
        if (newStatus) {
          // Was restored, so refresh dropped list to remove them
          loadDropped();
        } else {
          // Was dropped, refresh active list to remove them
          loadStudents();
        }
      }

      async function loadBranchesDropdown() {
        const { data } = await supabase.from("branches").select("*");
        const selects = ["filter-branch", "modal-branch", "assign-branch"];

        selects.forEach((selId) => {
          const el = document.getElementById(selId);
          if (!el) return;
          if (selId === "filter-branch")
            el.innerHTML = '<option value="all">All Branches</option>';
          else el.innerHTML = "";

          data.forEach((b) => {
            el.innerHTML += `<option value="${b.id}">${b.name}</option>`;
          });
        });
      }

      async function loadBranchesList() {
        const list = document.getElementById("branch-list");
        list.innerHTML = "Loading...";
        const { data } = await supabase
          .from("branches")
          .select("*")
          .order("id");

        list.innerHTML = "";
        data.forEach((b) => {
          list.innerHTML += `<div class="card"><div class="info"><h4>${b.name}</h4></div></div>`;
        });
      }

      async function createBranch() {
        const name = document.getElementById("new-branch-name").value;
        if (!name) return alert("Enter name");

        const { error } = await supabase.from("branches").insert({ name });
        if (error) alert(error.message);
        else {
          alert("Branch Created!");
          document.getElementById("new-branch-name").value = "";
          loadBranchesList();
          loadBranchesDropdown();
        }
      }

      async function loadTeachersList() {
        // Load Teachers for Dropdown
        const { data: teachers } = await supabase
          .from("profiles")
          .select("*")
          .eq("role", "teacher");
        const sel = document.getElementById("assign-teacher");
        sel.innerHTML = "";
        teachers.forEach(
          (t) =>
            (sel.innerHTML += `<option value="${t.id}">${t.full_name || "No Name"}</option>`),
        );

        // Load Assignments List
        const list = document.getElementById("teacher-list");
        list.innerHTML = "Loading...";

        const { data: assignments } = await supabase
          .from("teacher_branches")
          .select(
            "id, branch_id, teacher_id, branches(name), profiles(full_name)",
          );

        list.innerHTML = "";
        if (!assignments || assignments.length === 0)
          list.innerHTML = "<p>No assignments yet.</p>";

        assignments.forEach((a) => {
          list.innerHTML += `
                <div class="card">
                    <div class="info">
                        <h4>${a.profiles.full_name}</h4>
                        <p>Branch: <b>${a.branches.name}</b></p>
                    </div>
                    <div class="actions">
                        <button class="btn-drop" onclick="removeAssignment(${a.id})">Remove</button>
                    </div>
                </div>`;
        });
      }

      async function removeAssignment(id) {
        if (!confirm("Remove teacher from this branch?")) return;
        await supabase.from("teacher_branches").delete().eq("id", id);
        loadTeachersList();
      }

      // --- 3. FORM HANDLERS ---
      document
        .getElementById("student-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const { error } = await supabase.from("students").insert({
            branch_id: document.getElementById("modal-branch").value,
            name: document.getElementById("m-name").value,
            phone: document.getElementById("m-phone").value,
            fee_amount: document.getElementById("m-fee").value,
            billing_day: document.getElementById("m-day").value,
            is_active: true,
          });
          if (error) alert(error.message);
          else {
            closeModal("student-modal");
            loadStudents();
          }
        });

      document
        .getElementById("assign-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const { error } = await supabase.from("teacher_branches").insert({
            teacher_id: document.getElementById("assign-teacher").value,
            branch_id: document.getElementById("assign-branch").value,
          });
          if (error) alert("Error: " + error.message);
          else {
            closeModal("assign-modal");
            loadTeachersList();
          }
        });

      // --- UTILS ---
      function openModal(id) {
        document.getElementById(id).style.display = "flex";
      }
      function closeModal(id) {
        document.getElementById(id).style.display = "none";
      }
      async function logout() {
        await supabase.auth.signOut();
        window.location.href = "index.html";
      }
    </script>
  </body>
</html>
