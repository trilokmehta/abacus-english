<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teacher Dashboard - Brainiac Gym</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
      :root {
        --brand-orange: #ff6b00;
        --brand-orange-light: #fff0e0;
        --text-dark: #333;
        --success: #28a745;
        --danger: #dc3545;
        --bg-color: #f8f9fa;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", sans-serif;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-dark);
        padding-bottom: 80px;
      }

      /* --- Header --- */
      .header {
        background: white;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .brand {
        font-weight: 800;
        color: var(--brand-orange);
        font-size: 1.1rem;
      }

      .btn-logout {
        background: none;
        border: 1px solid #ddd;
        padding: 5px 10px;
        border-radius: 6px;
        font-size: 0.8rem;
      }

      /* --- Controls --- */
      .controls {
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      h2 {
        font-size: 1.2rem;
        margin-bottom: 5px;
      }
      .branch-label {
        font-size: 0.85rem;
        color: #666;
      }

      .btn-add {
        background: var(--brand-orange);
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 25px;
        cursor: pointer;
        font-weight: 600;
        box-shadow: 0 4px 10px rgba(255, 107, 0, 0.3);
      }

      /* --- Student List --- */
      .student-list {
        padding: 0 15px;
      }

      .student-card {
        background: white;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 12px;
        border-left: 6px solid #ddd;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      }

      .student-card.Paid {
        border-left-color: var(--success);
      }
      .student-card.Pending {
        border-left-color: var(--danger);
      }

      .st-info h4 {
        font-size: 1.1rem;
        margin-bottom: 4px;
      }
      .st-info p {
        font-size: 0.85rem;
        color: #777;
      }

      .status-badge {
        font-size: 0.75rem;
        font-weight: bold;
        text-transform: uppercase;
        padding: 4px 8px;
        border-radius: 4px;
        display: inline-block;
        margin-top: 5px;
      }
      .status-badge.Paid {
        background: #e8f5e9;
        color: var(--success);
      }
      .status-badge.Pending {
        background: #ffebee;
        color: var(--danger);
      }

      .btn-pay {
        background: var(--text-dark);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 8px;
        font-size: 0.85rem;
        cursor: pointer;
        margin-left: 10px;
      }

      .btn-pay.disabled {
        background: #ccc;
        cursor: default;
      }

      /* --- Modal --- */
      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 200;
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: white;
        width: 90%;
        max-width: 400px;
        padding: 20px;
        border-radius: 16px;
      }
      .modal h3 {
        margin-bottom: 15px;
        color: var(--brand-orange);
      }
      .form-group {
        margin-bottom: 15px;
      }
      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 0.9rem;
      }
      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: #fafafa;
      }
      .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }
      .btn-cancel {
        background: #f0f0f0;
        color: #333;
        border: none;
        padding: 12px;
        flex: 1;
        border-radius: 8px;
      }
      .btn-save {
        background: var(--brand-orange);
        color: white;
        border: none;
        padding: 12px;
        flex: 1;
        border-radius: 8px;
      }
    </style>
  </head>
  <body>
    <div class="header">
      <div class="brand">Brainiac Teacher</div>
      <button class="btn-logout" onclick="logout()">Logout</button>
    </div>

    <div class="controls">
      <div>
        <h2>My Students</h2>
        <div class="branch-label" id="branch-name">Loading...</div>
      </div>
      <button class="btn-add" onclick="openModal()">+ Add New</button>
    </div>

    <div class="student-list" id="student-list">
      <p style="text-align: center; color: #999; margin-top: 30px">
        Loading your class...
      </p>
    </div>

    <div class="modal" id="add-modal">
      <div class="modal-content">
        <h3>New Admission</h3>
        <form id="add-form">
          <div class="form-group">
            <label>Student Name</label>
            <input type="text" id="modal-name" placeholder="Name" required />
          </div>
          <div class="form-group">
            <label>Phone (For Office Use Only)</label>
            <input type="tel" id="modal-phone" placeholder="9876..." required />
          </div>
          <div class="form-group">
            <label>Fee Amount (₹)</label>
            <input type="number" id="modal-fee" placeholder="Amount" required />
          </div>
          <div class="form-group">
            <label>Billing Day (1-28)</label>
            <input
              type="number"
              id="modal-day"
              placeholder="e.g. 8"
              min="1"
              max="28"
              required
            />
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-cancel" onclick="closeModal()">
              Cancel
            </button>
            <button type="submit" class="btn-save">Add Student</button>
          </div>
        </form>
      </div>
    </div>

    <script>
      // --- 1. CONFIGURATION ---
      const SUPABASE_URL = "https://moktlyeoljidtjbokqne.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1va3RseWVvbGppZHRqYm9rcW5lIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkwMTIwODQsImV4cCI6MjA4NDU4ODA4NH0.ZnDXCZi58_srExZVLjMTsZVdrF-MyOpDDv27vVx_K5k";

      const supabaseClient = supabase.createClient(
        SUPABASE_URL,
        SUPABASE_ANON_KEY,
      );

      // Global Variable to store teacher's branch
      let myBranchId = null;

      // --- 2. AUTH & INIT ---
      async function checkAuth() {
        const {
          data: { session },
        } = await supabaseClient.auth.getSession();
        if (!session) window.location.href = "index.html";

        // Get Teacher's Branch
        const { data: assignment, error } = await supabaseClient
          .from("teacher_branches")
          .select("branch_id, branches(name)")
          .eq("teacher_id", session.user.id)
          .single();

        if (error || !assignment) {
          alert("You are not assigned to any branch yet. Ask Admin.");
          return;
        }

        myBranchId = assignment.branch_id;
        document.getElementById("branch-name").textContent =
          assignment.branches.name;
        loadStudents();
      }
      checkAuth();

      // --- 3. LOAD STUDENTS (FROM VIEW) ---
      // Note: We use 'teacher_student_view' so we don't see phone numbers
      async function loadStudents() {
        const listContainer = document.getElementById("student-list");
        listContainer.innerHTML =
          '<p style="text-align:center; color:#999">Updating list...</p>';

        const { data: students, error } = await supabaseClient
          .from("teacher_student_view")
          .select("*")
          .eq("branch_id", myBranchId);

        if (error) {
          console.error(error);
          listContainer.innerHTML =
            '<p style="color:red">Error loading students</p>';
          return;
        }

        if (students.length === 0) {
          listContainer.innerHTML =
            '<p style="text-align:center; color:#999; margin-top:20px">No students yet.</p>';
          return;
        }

        listContainer.innerHTML = "";

        students.forEach((s) => {
          const isPaid = s.status === "Paid";

          const card = document.createElement("div");
          card.className = `student-card ${s.status}`;

          card.innerHTML = `
                    <div class="st-info">
                        <h4>${s.name}</h4>
                        <p>Due Date: ${s.billing_day}th of month</p>
                        <span class="status-badge ${s.status}">${s.status}</span>
                    </div>
                    <div>
                        ${
                          !isPaid
                            ? `<button onclick="markPaid('${s.student_id}', '${s.name}')" class="btn-pay">Collect Fee</button>`
                            : `<button class="btn-pay disabled">✅ Done</button>`
                        }
                    </div>
                `;
          listContainer.appendChild(card);
        });
      }

      // --- 4. MARK PAID LOGIC ---
      async function markPaid(studentId, studentName) {
        if (!confirm(`Confirm payment received for ${studentName}?`)) return;

        // 1. We need the Amount (Teachers can't see it, but the DB knows it)
        // We insert into payments table. The trigger/policy will handle validation if needed.
        // Since teacher doesn't know the amount, we can either:
        // A) Require Admin to verify
        // B) Trust Teacher and lookup amount in backend.
        // For this app, we simply record the "event" of payment.

        // However, the payments table requires an amount.
        // We will fetch the amount using a specialized RPC or just insert a dummy amount
        // if we want to be strict, but better:

        // WORKAROUND: Teacher performs a "Blind Insert".
        // We need to fetch the fee_amount first? No, RLS prevents reading it.
        // Solution: We will trust the teacher has collected "The Fee" and just insert 0 or
        // we update the policy to allow teachers to read fee_amount for *specific* logic?

        // To keep it simple for now: We will insert a record.
        // Note: In a real app, you'd use a Supabase Function to "pay_fee(student_id)" securely.
        // Here, we will assume the teacher enters the amount they collected:

        const amountCollected = prompt(
          `Enter amount collected for ${studentName}:`,
        );
        if (!amountCollected) return;

        const { error } = await supabaseClient.from("payments").insert({
          student_id: studentId,
          amount_paid: parseInt(amountCollected),
          payment_for_month: new Date().toISOString(), // Pays for today
        });

        if (error) {
          alert("Error: " + error.message);
        } else {
          alert("Payment Recorded!");
          loadStudents();
        }
      }

      // --- 5. ADD STUDENT LOGIC ---
      const modal = document.getElementById("add-modal");
      const form = document.getElementById("add-form");

      function openModal() {
        modal.style.display = "flex";
      }
      function closeModal() {
        modal.style.display = "none";
      }

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Teachers can INSERT into 'students', even though they can't SELECT phone numbers later.
        const newStudent = {
          branch_id: myBranchId,
          name: document.getElementById("modal-name").value,
          phone: document.getElementById("modal-phone").value,
          fee_amount: document.getElementById("modal-fee").value,
          billing_day: document.getElementById("modal-day").value,
          is_active: true,
        };

        const { error } = await supabaseClient
          .from("students")
          .insert(newStudent);

        if (error) {
          alert("Error: " + error.message);
        } else {
          alert("Student Added! (Details are now hidden)");
          closeModal();
          form.reset();
          loadStudents();
        }
      });

      async function logout() {
        await supabaseClient.auth.signOut();
        window.location.href = "index.html";
      }
    </script>
  </body>
</html>
